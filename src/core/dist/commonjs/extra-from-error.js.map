{"version":3,"file":"extra-from-error.js","sourceRoot":"","sources":["../../src/extra-from-error.ts"],"names":[],"mappings":"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","sourcesContent":["import type { CallSiteLike } from '@tapjs/stack'\nimport * as stack from '@tapjs/stack'\nimport type { BaseOpts } from './base.js'\nimport { Extra } from './index.js'\n\n// test that a CallSiteLike is \"useful\", ie, has a file/line/col\nconst useful = (at: CallSiteLike | undefined) =>\n  !!at?.fileName &&\n  typeof at.lineNumber === 'number' &&\n  typeof at.columnNumber === 'number'\n\n/**\n * Create an {@link @tapjs/core!index.Extra} object based on a thrown Error\n */\nexport const extraFromError = (\n  er: any,\n  extra?: Extra,\n  options?: BaseOpts,\n) => {\n  // the yaml module puts big stuff here, pluck it off\n  // otherwise it's quite noisy when we throw as a result of\n  // trying to parse invalid tap diagnostics.\n  if (\n    !!er &&\n    typeof er === 'object' &&\n    er.source &&\n    typeof er.source === 'object' &&\n    er.source.context\n  ) {\n    const { context, ...source } = er.source\n    er.source = source\n  }\n\n  // pull out all fields from options, other than anything starting\n  // with tapChild, or anything already set in the extra object.\n  options = options ?? {}\n  extra = Object.assign(\n    extra ?? {},\n    Object.fromEntries(\n      Object.entries(options).filter(\n        ([k]) => !/^tapChild/.test(k) && !(k in (extra ?? {})),\n      ),\n    ),\n  )\n\n  if (!er || typeof er !== 'object') {\n    extra.error = er\n    return extra\n  }\n\n  const st = stack.captureError(er)\n  if (st && st.length) {\n    extra.stack = st.map(c => String(c)).join('\\n')\n    let at: CallSiteLike | undefined\n    // walk down the stack until we find the first \"useful\" stack frame\n    for (let i = 0; i < st.length; i++) {\n      if (useful(st[i])) {\n        at = st[i]\n        break\n      }\n    }\n    extra.at = at || st[0]\n  } else if (typeof er.stack === 'string') {\n    if (er instanceof Error) {\n      // if we failed to capture it, but it has a stack, then that means\n      // that all of the stack frames were internal, because the error was\n      // generated from native code in a dep that tap ignores (or if not\n      // native code, then something else that escaped the async-hook-domain).\n      // A common cause of this is import() errors.\n      extra.stack = ''\n    } else {\n      extra.stack = er.stack\n    }\n    extra.at = null\n  }\n\n  if (er.name && er.name !== 'Error') {\n    extra.type = er.name\n  }\n\n  // grab any other rando props\n  const {\n    message: _,\n    stack: __,\n    name: ___,\n    cause,\n    errors,\n    ...props\n  } = er\n  Object.assign(extra, props)\n  if (cause !== undefined) extra.cause = cause\n  if (errors !== undefined) extra.errors = errors\n\n  return extra\n}\n"]}